<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Eumar Rice Mill</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #2c3e50;
      background-color: #f5f6f7;
      overflow: hidden;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 230px;
      height: 100vh;
      background-color: #0b6514; 
      color: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 40px 25px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .sidebar h2 {
      display: flex;
      align-items: center;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 40px;
    }

    .sidebar h2 i {
      margin-right: 10px;
      font-size: 1.4rem;
    }

    .sidebar a {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      color: #ffffff;
      font-weight: 600;
      text-decoration: none;
      padding: 12px 18px;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: #34a853; 
    }

    .sidebar a:last-child {
      margin-top: auto;
    }

    .main-content {
      position: absolute;
      top: 0;
      left: 230px;  
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #f5f6f7;
    }

    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
    }

    .card {
      margin: 0;
      border-radius: 0;
      flex-shrink: 0;
      width: 100%;
    }

    .card h5 {
      margin-bottom: 1rem;
    }

     .chart-container {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .chart-box {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      min-width: 300px;  
      height: 380px;
    }

    .chart-box canvas {
      flex: 1 1 auto;
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>

<nav class="sidebar">
  <h2><i class="bi bi-person-badge-fill"></i> Staff Panel</h2>
  <a href="/staff-overview"><i class="bi bi-speedometer2"></i> Overview</a>
  <a href="/queue"><i class="bi bi-people-fill"></i> Queue</a>
  <a href="/sales" class="active"><i class="bi bi-bar-chart-line-fill"></i> Sale</a>
  <a href="/staff-inventory"><i class="bi bi-box-seam-fill"></i> Inventory</a>
  <a href="/logout"><i class="bi bi-box-arrow-right"></i> Logout</a>
</nav>
<div class="main-content">
  <div class="content-wrapper">

     <div class="card shadow-sm p-4 mb-4">
      <h5 class="text-primary fw-bold">Sales Overview</h5>
      <div class="row g-4">
        <div class="col-md-6">
          <canvas id="monthly-sales-chart"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="daily-sales-chart"></canvas>
        </div>
      </div>
    </div>

     <div class="card shadow-sm p-4">
      <h5 class="text-success fw-bold">Manual Input</h5>
      <form id="manual-order-form">
        <div class="row g-4">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Customer Name</label>
            <input type="text" class="form-control" id="name" required>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Contact Number</label>
            <input type="text" class="form-control" id="contact_number" placeholder="Optional">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Service Type</label>
            <select class="form-select" id="serviceType" required>
              <option selected disabled>Select service</option>
              <option value="purchasing">Purchasing</option>
              <option value="milling">Milling</option>
            </select>
          </div>
          <div class="col-md-6" id="product-section" style="display:none;">
            <label class="form-label fw-semibold">Product</label>
            <select class="form-select" id="product"></select>
          </div>
          <div class="col-md-6" id="quantity-section" style="display:none;">
            <label class="form-label fw-semibold">Quantity</label>
            <input type="number" class="form-control" id="quantity" min="1" value="1">
          </div>
          <div class="col-md-6" id="amount-section" style="display:none;">
            <label class="form-label fw-semibold">Amount (₱)</label>
            <input type="text" class="form-control" id="amount" readonly>
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Notes</label>
            <textarea class="form-control" id="notes" rows="2" placeholder="Optional"></textarea>
          </div>
          <div class="col-12 text-center mt-4">
            <button type="submit" class="btn btn-success px-5 py-2" id="manual-submit-btn">Submit</button>
          </div>
        </div>
      </form>
    </div>

  </div>
</div>

 <div class="modal fade" id="submitModal" tabindex="-1" aria-labelledby="submitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">  
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="submitModalLabel">Order Submitted</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Your order has been successfully submitted.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const serviceTypeSelect = document.getElementById('serviceType');
  const productSection = document.getElementById('product-section');
  const quantitySection = document.getElementById('quantity-section');
  const amountSection = document.getElementById('amount-section');
  const productSelect = document.getElementById('product');
  const quantityInput = document.getElementById('quantity');
  const amountInput = document.getElementById('amount');
  const manualForm = document.getElementById('manual-order-form');
  const submitBtn = document.getElementById('manual-submit-btn');

  let products = [];

  async function loadProducts() {
    try {
      const res = await fetch('/api/products');
      products = await res.json();
      productSelect.innerHTML = products.length
        ? `<option selected disabled>Select product</option>` + products.map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} (${p.quantity} in stock)</option>`).join('')
        : `<option disabled>No products available</option>`;
      calculateAmount();
    } catch (err) {
      console.error('Failed to load products', err);
      productSelect.innerHTML = `<option disabled>Failed to load products</option>`;
    }
  }

  function calculateAmount() {
    const selectedProductId = parseInt(productSelect.value);
    const qty = parseInt(quantityInput.value) || 1;
    const product = products.find(p => p.id === selectedProductId);
    amountInput.value = product ? (product.price * qty).toFixed(2) : '';
  }

  productSelect.addEventListener('change', calculateAmount);
  quantityInput.addEventListener('input', calculateAmount);

  serviceTypeSelect.addEventListener('change', () => {
    const value = serviceTypeSelect.value;
    if (value === 'purchasing') {
      productSection.style.display = 'block';
      quantitySection.style.display = 'block';
      amountSection.style.display = 'block';
      loadProducts();
    } else {
      productSection.style.display = 'none';
      quantitySection.style.display = 'none';
      amountSection.style.display = 'none';
      amountInput.value = '';
    }
  });

  manualForm.addEventListener('submit', async e => {
    e.preventDefault();
    const data = {
      serviceType: serviceTypeSelect.value,
      name: document.getElementById('name').value.trim(),
      contact_number: document.getElementById('contact_number').value.trim(),
      product: productSelect.value ? parseInt(productSelect.value) : null,
      quantity: quantityInput.value ? parseInt(quantityInput.value) : null,
      notes: document.getElementById('notes').value.trim(),
      amount: amountInput.value ? parseFloat(amountInput.value) : null
    };

    submitBtn.disabled = true;
    submitBtn.innerText = 'Submitting...';

    try {
      const res = await fetch('/place-order', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(data)
      });
      if(!res.ok) throw new Error('Failed to place order');
     const submitModal = new bootstrap.Modal(document.getElementById('submitModal'));
submitModal.show();

manualForm.reset();
serviceTypeSelect.dispatchEvent(new Event('change'));
await loadMonthlySales();
await loadDailySales();

    } catch(err) {
      alert(`Error: ${err.message}`);
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerText = 'Submit';
    }
  });

   let monthlyChart, dailyChart;
  let dailyData = [], dailyLabels = [];

  async function loadMonthlySales() {
    try {
      const res = await fetch('/api/sales-summary');
      const data = await res.json();
      const labels = data.map(item => {
        const [year, month] = item.label.split('-');
        const date = new Date(year, month - 1);
        return date.toLocaleString('en-US', { month: 'short', year: 'numeric' });
      });
      const amounts = data.map(item => item.amount);

      const ctx = document.getElementById('monthly-sales-chart').getContext('2d');
      if (monthlyChart) monthlyChart.destroy();

      monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Total Sales (₱)', data: amounts, backgroundColor: 'rgba(54, 162, 235, 0.7)' }] },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    } catch(err) { console.error('Failed to load monthly sales', err); }
  }
async function loadDailySales() {
  try {
    const res = await fetch('/api/daily-sales');
    const data = await res.json();

    const chartData = data.map(d => ({
      x: new Date(d.date),
      y: d.amount
    }));

    const ctx = document.getElementById('daily-sales-chart').getContext('2d');
    if (dailyChart) dailyChart.destroy();

    dailyChart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Daily Income (₱)',
          data: chartData,
          fill: true,
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          tooltip: {
            enabled: true,
            mode: 'nearest',
            intersect: false,
            callbacks: {
              label: function(context) {
                 const value = Number(context.parsed.y) || 0;
                return `₱ ${value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day',
              tooltipFormat: 'MMM dd, yyyy'
            },
            grid: {
              color: '#eee'
            },
            ticks: {
              maxRotation: 45,
              minRotation: 45,
              autoSkip: true,
              maxTicksLimit: 10,
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: '#eee'
            },
            ticks: {
              callback: function(value) {
                return '₱' + value.toLocaleString();
              }
            }
          }
        }
      }
    });
  } catch(err) {
    console.error('Failed to load daily sales', err);
  }
}

function startDailyUpdates() {
  setInterval(async () => {
    try {
      const res = await fetch('/api/daily-sales');
      const data = await res.json();

      data.forEach(d => {
        const dateObj = new Date(d.date);
        const idx = dailyChart.data.datasets[0].data.findIndex(p => p.x.getTime() === dateObj.getTime());
        if (idx !== -1) {
          dailyChart.data.datasets[0].data[idx].y = d.amount;
        } else {
          dailyChart.data.datasets[0].data.push({ x: dateObj, y: d.amount });
        }
      });
      dailyChart.update('active');
    } catch(err) {
      console.error('Failed to update daily sales', err);
    }
  }, 5000);
}


  loadMonthlySales();
  loadDailySales().then(() => startDailyUpdates());
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
